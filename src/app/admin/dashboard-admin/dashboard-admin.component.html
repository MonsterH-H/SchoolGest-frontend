<div class="min-h-full bg-[#FAFBFF] p-4 lg:p-8 animate-fadeIn">

  <!-- Header Section -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
    <div>
      <h1 class="text-2xl lg:text-3xl font-extrabold text-slate-900 tracking-tight">Vue d'ensemble</h1>
      <p class="text-slate-500 font-medium">Statistiques en temps réel du système SchoolGest</p>
    </div>

    <div class="flex items-center gap-3">
      <div class="hidden sm:flex flex-col items-end mr-2">
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">État du serveur</span>
        <div class="flex items-center gap-1.5 mt-1">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
          </span>
          <span class="text-sm font-semibold text-emerald-600">{{ stats()?.databaseStatus || 'Connecté' }}</span>
        </div>
      </div>

      <button (click)="loadStats()"
        class="inline-flex items-center justify-center p-2.5 rounded-xl bg-white border border-slate-200 shadow-sm text-slate-600 hover:text-indigo-600 hover:border-indigo-100 hover:bg-indigo-50/50 transition-all duration-200"
        [disabled]="isLoading()">
        <svg [class.animate-spin]="isLoading()" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
          </path>
        </svg>
      </button>

      <button
        class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-indigo-200 transition-all font-bold text-sm">
        Télécharger rapport
      </button>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMsg()) {
    <div
      class="mb-8 p-4 bg-rose-50 border border-rose-100 rounded-2xl flex items-center gap-4 text-rose-700 animate-slideInRight">
      <div class="p-2 bg-rose-100 rounded-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <span class="font-medium text-sm">{{ errorMsg() }}</span>
    </div>
  }

  <!-- KPI Cards Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
    @for (card of kpiCards(); track card.title) {
      <div
        class="group bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-indigo-500/5 transition-all duration-300">
        <div class="flex justify-between items-start mb-4">
          <div class="p-3 rounded-2xl"
            [className]="'p-3 rounded-2xl ' + card.colorClasses.bg + ' ' + card.colorClasses.icon">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="card.iconPath"></path>
            </svg>
          </div>
          @if (card.trend) {
            <div
              [className]="'flex items-center gap-1 text-[10px] font-bold px-2 py-1 rounded-full ' + (card.trendPositive ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600')">
              <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                @if (card.trendPositive) {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                    d="M5 10l7-7 7 7M12 3v18"></path>
                } @else {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                    d="M19 14l-7 7-7-7M12 21V3"></path>
                }
              </svg>
              {{ card.trend }}
            </div>
          }
        </div>
        <div>
          <h3 class="text-3xl font-extrabold text-slate-900 group-hover:scale-105 transition-transform origin-left">{{
            card.value }}</h3>
          <p class="text-slate-400 font-bold text-xs uppercase tracking-widest mt-1">{{ card.title }}</p>
        </div>
        <div class="mt-4 pt-4 border-t border-slate-50">
          <p class="text-[11px] text-slate-400 font-medium">{{ card.description }}</p>
        </div>
      </div>
    }
  </div>

  <!-- Charts Section -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Main Bar Chart -->
    <div class="lg:col-span-2 bg-white p-8 rounded-[32px] border border-slate-100 shadow-sm">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-lg font-bold text-slate-900">Activité Hebdomadaire</h2>
          <p class="text-xs text-slate-400 font-medium mt-1">Comparaison du taux de présence</p>
        </div>
        <select
          class="text-xs font-bold text-slate-500 bg-slate-50 border-none rounded-lg px-3 py-2 outline-none cursor-pointer hover:bg-slate-100 transition-colors">
          <option>Cette semaine</option>
          <option>Semaine dernière</option>
        </select>
      </div>
      <div class="h-72 w-full">
        <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="'bar'">
        </canvas>
      </div>
    </div>

    <!-- Distribution Chart -->
    <div class="bg-white p-8 rounded-[32px] border border-slate-100 shadow-sm">
      <h2 class="text-lg font-bold text-slate-900 mb-2 text-center">Répartition</h2>
      <p class="text-xs text-slate-400 font-medium text-center mb-8">Poids des utilisateurs par rôle</p>
      <div class="h-56 relative flex items-center justify-center">
        <canvas baseChart [data]="donutChartData" [options]="donutChartOptions" [type]="'doughnut'">
        </canvas>
        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
          <span class="text-2xl font-black text-slate-700">{{ (stats()?.totalStudents || 0) + (stats()?.totalTeachers ||
            0) }}</span>
          <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Total</span>
        </div>
      </div>

      <!-- Chart Labels custom -->
      <div class="mt-6 space-y-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full bg-indigo-500"></span>
            <span class="text-xs font-bold text-slate-600">Admin</span>
          </div>
          <span class="text-xs font-black text-slate-800">5</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
            <span class="text-xs font-bold text-slate-600">Enseignants</span>
          </div>
          <span class="text-xs font-black text-slate-800">{{ stats()?.totalTeachers }}</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full bg-amber-400"></span>
            <span class="text-xs font-bold text-slate-600">Étudiants</span>
          </div>
          <span class="text-xs font-black text-slate-800">{{ stats()?.totalStudents }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Section: Quick Links & Alerts -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
    <div
      class="bg-gradient-to-br from-indigo-700 to-purple-800 p-8 rounded-[32px] text-white overflow-hidden relative group">
      <div class="relative z-10">
        <h2 class="text-xl font-bold mb-2">Gestion Centralisée</h2>
        <p class="text-indigo-100 text-sm mb-6 max-w-[280px]">Gérez les comptes utilisateurs, leurs rôles et suivez les
          activités du système ou importez des données.</p>
        <div class="flex flex-wrap gap-3">
          <a routerLink="/admin/users"
            class="bg-white/10 hover:bg-white/20 backdrop-blur-md px-4 py-2 rounded-xl text-xs font-bold transition-all border border-white/10">Liste
            des utilisateurs</a>
          <button
            class="bg-white text-indigo-700 px-4 py-2 rounded-xl text-xs font-extrabold shadow-lg transition-all hover:scale-105 active:scale-95">Importer
            des élèves</button>
        </div>
      </div>
      <!-- Background circles for flair -->
      <div
        class="absolute -right-10 -bottom-10 w-48 h-48 bg-white/10 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-700">
      </div>
    </div>

    <div class="bg-white p-8 rounded-[32px] border border-slate-100 shadow-sm">
      <h2 class="text-lg font-bold text-slate-900 mb-6">Activités Récentes</h2>
      <div class="space-y-6">
        <div class="flex gap-4">
          <div class="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
              </path>
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-slate-800">5 nouvelles absences enregistrées</p>
            <p class="text-[11px] text-slate-400 font-medium">Il y a 10 minutes • Classe 3ème B</p>
          </div>
        </div>
        <div class="flex gap-4">
          <div class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
              </path>
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-slate-800">Génération des bulletins T1</p>
            <p class="text-[11px] text-slate-400 font-medium">Il y a 2 heures • Réussite : 98%</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Maintenance Section (Batch Actions from Spec) -->
  <div class="bg-white rounded-[40px] p-8 border border-slate-100 shadow-xl overflow-hidden relative group">
    <div
      class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-rose-50 rounded-full blur-3xl opacity-50 group-hover:opacity-80 transition-opacity">
    </div>

    <div class="relative z-10 flex flex-col lg:flex-row items-center justify-between gap-8">
      <div class="flex items-center gap-6">
        <div
          class="w-16 h-16 rounded-3xl bg-rose-600 text-white flex items-center justify-center shadow-lg shadow-rose-200">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z">
            </path>
          </svg>
        </div>
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Maintenance Académique</h2>
          <p class="text-slate-400 font-bold">Actions critiques sur les résultats et bulletins (Admin Only)</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-4">
        <button (click)="onCalculateRanks(1)"
          class="bg-slate-900 hover:bg-black text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl transition-all border border-slate-800">
          Recalculer les Rangs
        </button>
        <button (click)="onGenerateBulletins(1)"
          class="bg-rose-600 hover:bg-rose-700 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-[0.1em] shadow-lg shadow-rose-200 transition-all">
          Générer les Bulletins
        </button>
      </div>
    </div>
  </div>
</div>
